name: Deploy Custom WordPress Code Only

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Verify Target Paths Exist
      run: |
        ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "
          # Verify WordPress directory exists
          if [ ! -d '${{ secrets.VPS_PATH }}' ]; then
            echo '‚ùå WordPress path does not exist: ${{ secrets.VPS_PATH }}'
            exit 1
          fi
          
          # Verify wp-content structure exists
          if [ ! -d '${{ secrets.VPS_PATH }}/wp-content' ]; then
            echo '‚ùå wp-content directory missing'
            exit 1
          fi
          
          # Create plugin/theme directories if they don't exist
          mkdir -p '${{ secrets.VPS_PATH }}/wp-content/plugins'
          mkdir -p '${{ secrets.VPS_PATH }}/wp-content/themes'
          
          echo '‚úÖ Target paths verified'
        "
        
    - name: Deploy Custom Plugin - demaandagavond-engine
      run: |
        if [ -d "./wp-content/plugins/demaandagavond-engine" ]; then
          rsync -avz \
            ./wp-content/plugins/demaandagavond-engine/ \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:'${{ secrets.VPS_PATH }}/wp-content/plugins/demaandagavond-engine/'
          echo '‚úÖ Custom plugin deployed'
        else
          echo '‚ö†Ô∏è Custom plugin directory not found in repository'
        fi
        
    - name: Deploy Custom Theme - DMAv7
      run: |
        if [ -d "./wp-content/themes/DMAv7" ]; then
          rsync -avz \
            ./wp-content/themes/DMAv7/ \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:'${{ secrets.VPS_PATH }}/wp-content/themes/DMAv7/'
          echo '‚úÖ Custom theme deployed'
        else
          echo '‚ö†Ô∏è Custom theme directory not found in repository'
        fi

    - name: Set Correct Permissions
      run: |
        ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "
          echo 'Setting permissions for custom plugin...'
          sudo chown -R www-data:www-data '${{ secrets.VPS_PATH }}/wp-content/plugins/demaandagavond-engine/'
          sudo find '${{ secrets.VPS_PATH }}/wp-content/plugins/demaandagavond-engine/' -type f -exec chmod 644 {} \\;
          sudo find '${{ secrets.VPS_PATH }}/wp-content/plugins/demaandagavond-engine/' -type d -exec chmod 755 {} \\;

          echo 'Setting permissions for custom theme...'
          sudo chown -R www-data:www-data '${{ secrets.VPS_PATH }}/wp-content/themes/DMAv7/'
          sudo find '${{ secrets.VPS_PATH }}/wp-content/themes/DMAv7/' -type f -exec chmod 644 {} \\;
          sudo find '${{ secrets.VPS_PATH }}/wp-content/themes/DMAv7/' -type d -exec chmod 755 {} \\;

          if [ -d '${{ secrets.VPS_PATH }}/wp-content/mu-plugins/' ]; then
            echo 'Setting permissions for mu-plugins...'
            sudo chown -R www-data:www-data '${{ secrets.VPS_PATH }}/wp-content/mu-plugins/'
            sudo find '${{ secrets.VPS_PATH }}/wp-content/mu-plugins/' -type f -exec chmod 644 {} \\;
            sudo find '${{ secrets.VPS_PATH }}/wp-content/mu-plugins/' -type d -exec chmod 755 {} \\;
          fi
        "

    - name: Verify Deployment Success
      run: |
        ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "
          echo 'üîç Verifying deployment...'

          # Check plugin files
          if [ -f '${{ secrets.VPS_PATH }}/wp-content/plugins/demaandagavond-engine/dma_engine.php' ]; then
            echo '‚úÖ Custom plugin deployed successfully'
          else
            echo '‚ùå Custom plugin deployment failed'
          fi

          # Check theme files
          if [ -d '${{ secrets.VPS_PATH }}/wp-content/themes/DMAv7/' ]; then
            echo '‚úÖ Custom theme deployed successfully'
            ls -la '${{ secrets.VPS_PATH }}/wp-content/themes/DMAv7/' | head -5
          else
            echo '‚ùå Custom theme deployment failed'
          fi
        "